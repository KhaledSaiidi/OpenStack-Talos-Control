---
- name: Ensure Talos outputs dir exists
  file:
    path: "{{ talos_dir }}"
    state: directory
    mode: '0755'

- name: Write install patch (disk + wipe)
  copy:
    dest: "{{ talos_dir }}/patch-install.yaml"
    mode: '0644'
    content: |
      machine:
        install:
          disk: {{ talos_install_disk | default('/dev/vda') }}
          wipe: true

- name: Show the talosctl gen config command
  debug:
    msg: >
      {{ talosctl }} gen config {{ cluster_name }} https://{{ control_plane }}:6443
      --kubernetes-version {{ k8s_version }}
      --output-dir {{ talos_dir }}
      --config-patch @{{ talos_dir }}/patch-install.yaml
      {{ '--force' if force_gen_config | default(false) | bool else '' }}

# Use 'when' (not 'creates') so --force actually regenerates when requested
- name: Generate Talos cluster configs (controlplane.yaml, worker.yaml, talosconfig)
  command: >
    {{ talosctl }} gen config {{ cluster_name }} https://{{ control_plane }}:6443
    --kubernetes-version {{ k8s_version }}
    --output-dir {{ talos_dir }}
    --config-patch @{{ talos_dir }}/patch-install.yaml
    {{ '--force' if force_gen_config | default(false) | bool else '' }}
  register: gen_result
  changed_when: gen_result.rc == 0
  when: force_gen_config | default(false) | bool
        or not (lookup('ansible.builtin.fileglob', talos_dir + '/controlplane.yaml', errors='ignore'))