---
- name: Apply controlplane config to first CP (install + reboot)
  command: >
    {{ talosctl }} apply-config --insecure
    --nodes {{ control_plane }}
    --file {{ talos_dir }}/controlplane.yaml
  register: cp0_apply
  changed_when: cp0_apply.rc == 0

# Make the reboot explicit and resilient on the first CP
- name: Wait for Talos API to go down (reboot starting) on first CP
  wait_for:
    host: "{{ control_plane }}"
    port: 50000
    state: drained
    timeout: 300
  ignore_errors: true

- name: Wait for Talos API to come back (post-install) on first CP
  wait_for:
    host: "{{ control_plane }}"
    port: 50000
    state: started
    delay: 5
    timeout: 900

- name: Apply controlplane config to remaining CPs (if any)
  command: >
    {{ talosctl }} apply-config --insecure
    --nodes {{ other_masters | join(',') }}
    --file {{ talos_dir }}/controlplane.yaml
  when: other_masters | length > 0
  register: cpn_apply
  changed_when: cpn_apply.rc == 0

- name: Wait for Talos API to go down (reboot) on remaining CPs
  wait_for:
    host: "{{ item }}"
    port: 50000
    state: drained
    timeout: 300
  ignore_errors: true
  loop: "{{ other_masters }}"
  when: other_masters | length > 0

- name: Wait for Talos API to come back (post-install) on remaining CPs
  wait_for:
    host: "{{ item }}"
    port: 50000
    state: started
    delay: 5
    timeout: 900
  loop: "{{ other_masters }}"
  when: other_masters | length > 0