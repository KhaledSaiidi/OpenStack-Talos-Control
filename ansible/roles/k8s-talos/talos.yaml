---
- name: Bootstrap / reconcile Talos cluster
  hosts: localhost
  gather_facts: false
  collections:
    - community.general
  
  vars:
    masters: >-
      {{ groups['masters'] | map('extract', hostvars, 'ansible_host') | list }}
    workers: >-
      {{ groups['workers'] | map('extract', hostvars, 'ansible_host') | list }}
    talosctl:      "/usr/local/bin/talosctl"
    k8s_port:      6443

    talos_dir:     "{{ playbook_dir }}/talos-outputs"
    talosconfig:   "{{ talos_dir }}/talosconfig"

  environment:
    TALOSCONFIG: "{{ talosconfig }}"

  tasks:

  - name: Patch talosconfig with init master endpoint
    command: >
      {{ talosctl }} config endpoint {{ masters[0] }}
      --talosconfig {{ talosconfig }}
    register: patch_config
    changed_when: "'set current context endpoint' in patch_config.stdout"

  # - name: Apply control-plane config to init master
  #   command: >
  #     {{ talosctl }} apply-config
  #     --insecure
  #     -n {{ masters[0] }}
  #     --file {{ talos_dir }}/controlplane.yaml
  #   register: cp_apply
  #   retries: 5
  #   delay: 10
  #   until: cp_apply.rc == 0

  # - name: Bootstrap etcd cluster
  #   command: >
  #     {{ talosctl }} bootstrap
  #     -n {{ masters[0] }}
  #     --talosconfig {{ talos_dir }}/talosconfig
  #   register: bootstrap
  #   retries: 3
  #   delay: 5
  #   until: bootstrap.rc == 0

  # - name: Wait for Talos health on master nodes
  #   command: >
  #     {{ talosctl }} health
  #     -n {{ item }}
  #     --endpoints {{ masters[0] }}
  #   register: talos_health
  #   retries: 10
  #   delay: 5
  #   until: talos_health.rc == 0
  #   loop: "{{ masters }}"
  #   loop_control:
  #     label: "{{ item }}"
  #   delegate_to: localhost

  # - name: Ensure Kubernetes API is reachable
  #   wait_for:
  #     host: "{{ masters[0] }}"
  #     port: "{{ k8s_port }}"
  #     timeout: 300
  #   delegate_to: localhost

  # - name: Download kubeconfig
  #   command: >
  #     {{ talosctl }} kubeconfig
  #     {{ talos_dir }}/kubeconfig.yaml
  #     -n {{ masters[0] }}
  #     --endpoints {{ masters[0] }}
  #     --force
  #   retries: 5
  #   delay: 5
  #   register: kubeconfig_fetch
  #   until: kubeconfig_fetch.rc == 0

  # - debug:
  #     msg: "âœ” kubeconfig saved to {{ talos_dir }}/kubeconfig.yaml"

  # - name: Apply worker config securely
  #   when: workers | length > 0
  #   command: >
  #     {{ talosctl }} apply-config
  #     -n {{ item }}
  #     --endpoints {{ masters[0] }}
  #     --file {{ talos_dir }}/worker.yaml
  #   register: wk_apply
  #   retries: 5
  #   delay: 10
  #   until: wk_apply.rc == 0
  #   loop: "{{ workers }}"
  #   loop_control:
  #     label: "{{ item }}"
  #   delegate_to: localhost

  # - name: Wait for Talos health on worker nodes
  #   when: workers | length > 0
  #   command: >
  #     {{ talosctl }} health
  #     -n {{ item }}
  #     --endpoints {{ masters[0] }}
  #   register: talos_health
  #   retries: 10
  #   delay: 5
  #   until: talos_health.rc == 0
  #   loop: "{{ workers }}"
  #   loop_control:
  #     label: "{{ item }}"
  #   delegate_to: localhost