---
- name: Ensure cinder_lvm_device is defined
  ansible.builtin.assert:
    that:
      - cinder_lvm_device is defined
    fail_msg: "Set cinder_lvm_device (e.g., /dev/vdb)"

- name: Check that the backing device exists
  ansible.builtin.stat:
    path: "{{ cinder_lvm_device }}"
  register: cinder_device

- name: Abort when the Cinder device is missing
  ansible.builtin.fail:
    msg: "The device {{ cinder_lvm_device }} does not exist on {{ inventory_hostname }}."
  when: not cinder_device.stat.exists

- name: Install LVM packages
  ansible.builtin.apt:
    name:
      - lvm2
      - thin-provisioning-tools
    state: present
    update_cache: true

- name: Ensure the cinder-volumes VG exists on storage nodes
  ansible.builtin.lvg:
    vg: cinder-volumes
    pvs: "{{ cinder_lvm_device }}"
    pesize: 4
    state: present
